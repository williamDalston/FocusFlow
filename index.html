<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>7-Minute Journey</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --surface-color: #ffffff;
            --primary-color: #007aff;
            --primary-light: #e5f2ff;
            --secondary-color: #8e8e93;
            --text-color: #1c1c1e;
            --border-color: #e0e0e0;
            --warning-color: #ff3b30;
            --rest-color: #5856d6;
            --success-color: #34c759;
            --streak-color: #ff9500;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            --border-radius: 24px;
        }

        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }

        html, body {
            height: 100%; margin: 0; font-family: var(--font-family);
            background-color: var(--bg-color); color: var(--text-color);
            -webkit-tap-highlight-color: transparent; overflow: hidden;
        }

        body { display: flex; justify-content: center; align-items: center; padding: 1rem; }
        body.modal-open { overflow: hidden; }

        .app-container {
            border-radius: var(--border-radius); box-shadow: var(--shadow);
            padding: 1.5rem; width: 100%; max-width: 400px; text-align: center;
            display: flex; flex-direction: column; position: relative; overflow: hidden;
            background: linear-gradient(180deg, #87CEEB 0%, #FFDAB9 100%);
            transition: filter 1.5s ease;
        }
        
        .parallax-bg {
            position: absolute; top: 0; left: 0; width: 200%; height: 100%;
            background-repeat: repeat-x; background-position: 0 100%;
            transition: transform 1s cubic-bezier(0.645, 0.045, 0.355, 1);
            will-change: transform;
        }
        #bg-far { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 200"><path d="M0,150 C100,120 150,180 250,150 C350,120 400,180 500,150 C600,120 650,180 750,150 L800,150 L800,200 L0,200 Z" fill="rgba(0,122,255,0.1)"/></svg>'); z-index: 1; }
        #bg-mid { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 200"><path d="M0,160 C80,140 130,190 230,160 C330,130 380,190 480,160 C580,130 630,190 730,160 L800,160 L800,200 L0,200 Z" fill="rgba(0,122,255,0.2)"/></svg>'); z-index: 2; }
        #bg-near { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 200"><path d="M0,170 C50,160 100,180 200,170 C300,160 350,180 450,170 C550,160 600,180 700,170 L800,170 L800,200 L0,200 Z" fill="white"/></svg>'); z-index: 3; }

        .app-container.is-resting { animation: breathing 4s ease-in-out infinite; }
        @keyframes breathing { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(0.9); } }

        .app-content { position: relative; z-index: 4; background-color: transparent; }
        .app-view { animation: fadeIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .header-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--secondary-color); padding: 0.5rem; line-height: 1; }
        .app-title { font-size: 1.1rem; font-weight: 600; color: var(--text-color); }
        .streak-display { font-weight: 700; color: var(--streak-color); }

        .overall-progress-container {
            width: 100%; background-color: rgba(255,255,255,0.5);
            border-radius: 99px; height: 6px; margin-bottom: 1.5rem; overflow: hidden;
        }
        .overall-progress-bar { width: 0%; height: 100%; background-color: var(--primary-color); transition: width 1s cubic-bezier(0.645, 0.045, 0.355, 1), background-color 0.4s ease; }

        .timer-display { position: relative; margin-bottom: 1rem; }
        .exercise-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); font-size: 4.5rem; line-height: 1; opacity: 0; transition: opacity 0.4s ease, transform 0.4s ease; }
        .exercise-icon.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .timer-progress-ring { width: 220px; height: 220px; margin: 0 auto; position: relative; }
        .timer-progress-ring circle { transition: stroke-dashoffset 1s linear, stroke 0.4s ease; }
        .timer-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: 900; color: var(--text-color); transition: color 0.3s ease; }
        .timer-text.warning { color: var(--warning-color); }

        .exercise-info { min-height: 110px; display: flex; flex-direction: column; justify-content: center; margin-bottom: 1.5rem; position: relative; }
        .exercise-info > * { transition: opacity 0.4s ease, transform 0.4s ease; }
        .exercise-name { font-size: 2rem; font-weight: 700; line-height: 1.2; margin: 0; }
        .next-exercise-label { font-size: 1rem; font-weight: 600; color: var(--secondary-color); margin-top: 0.5rem; }

        .controls { display: flex; gap: 1rem; }
        .control-btn { flex-grow: 1; padding: 1rem; font-size: 1.1rem; font-weight: 700; border-radius: 12px; border: none; cursor: pointer; transition: all 0.2s ease; background-color: rgba(255,255,255,0.7); backdrop-filter: blur(10px); }
        .control-btn:active { transform: scale(0.96); }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: scale(1) !important; }
        .primary-btn { background-color: var(--primary-color); color: white; }
        .primary-btn.pause { background-color: var(--warning-color); }
        .secondary-btn { background-color: var(--primary-light); color: var(--primary-color); }

        .completion-screen { display: none; }
        .completion-icon { font-size: 5rem; color: var(--success-color); margin-bottom: 1rem; }
        .completion-title { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .completion-subtitle { font-size: 1.1rem; color: var(--secondary-color); margin-bottom: 1rem; }
        .completion-streak { font-size: 1.2rem; font-weight: 700; color: var(--streak-color); margin-bottom: 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; width: 100%; margin-bottom: 2rem; }
        .stat-item { text-align: center; opacity: 0; animation: fadeIn 0.5s ease forwards; }
        .stat-item:nth-child(2) { animation-delay: 0.2s; }
        .stat-item:nth-child(3) { animation-delay: 0.4s; }
        .stat-value { font-size: 1.75rem; font-weight: 700; }
        .stat-label { font-size: 0.9rem; color: var(--secondary-color); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; z-index: 1000; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-panel { background: var(--surface-color); border-radius: var(--border-radius); padding: 1.5rem; width: calc(100% - 2rem); max-width: 360px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-panel { transform: scale(1); }
        .modal-title { font-size: 1.25rem; font-weight: 700; margin: 0 0 1rem 0; text-align: center; }
        .modal-text { text-align: center; color: var(--secondary-color); margin-bottom: 1.5rem; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border-color); }
        .setting-item:first-of-type { border-top: 1px solid var(--border-color); }
        .setting-label { font-weight: 600; }
        .toggle-switch { width: 51px; height: 31px; background: #e9e9eb; border-radius: 99px; position: relative; cursor: pointer; transition: background-color 0.2s; }
        .toggle-switch.active { background-color: var(--success-color); }
        .toggle-switch::before { content: ''; position: absolute; top: 2px; left: 2px; width: 27px; height: 27px; background: white; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.15); transition: transform 0.2s; }
        .toggle-switch.active::before { transform: translateX(20px); }
        .modal-actions { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .modal-actions.row { flex-direction: row; }
        .btn-reset, .btn-confirm-reset { background-color: var(--warning-color); color: white; }

        .app-container.is-resting .progress-ring-fill { stroke: var(--rest-color); }
        .app-container.is-resting .overall-progress-bar { background-color: var(--rest-color); }
    </style>
</head>
<body>
    <div class="app-container" id="appContainer" aria-live="polite">
        <div class="parallax-bg" id="bg-far"></div>
        <div class="parallax-bg" id="bg-mid"></div>
        <div class="parallax-bg" id="bg-near"></div>
        
        <div class="app-content">
            <div id="workoutView" class="app-view">
                <header class="app-header">
                    <div class="streak-display" id="streakDisplay"></div>
                    <div class="app-title" id="viewTitle">Get Ready</div>
                    <button class="header-btn" id="settingsBtn" aria-label="Settings">‚öôÔ∏è</button>
                </header>
                <div class="overall-progress-container"><div class="overall-progress-bar" id="overallProgressBar"></div></div>
                <div class="timer-display">
                    <div class="exercise-icon" id="exerciseIcon"></div>
                    <svg class="timer-progress-ring" viewBox="0 0 120 120">
                        <circle class="progress-ring-bg" stroke="rgba(255,255,255,0.5)" stroke-width="8" fill="transparent" r="56" cx="60" cy="60"/>
                        <circle class="progress-ring-fill" id="progressRing" stroke="var(--primary-color)" stroke-width="8" fill="transparent" r="56" cx="60" cy="60" stroke-linecap="round" transform="rotate(-90 60 60)"/>
                    </svg>
                    <div class="timer-text" id="timerText" role="timer" aria-live="assertive">10</div>
                </div>
                <div class="exercise-info" id="exerciseInfoContainer">
                    <h2 class="exercise-name" id="exerciseName">Prepare to Start</h2>
                    <p class="next-exercise-label" id="nextExerciseLabel">First up: Jumping Jacks</p>
                </div>
                <div class="controls">
                    <button class="control-btn secondary-btn" id="skipBtn" disabled>Skip</button>
                    <button class="control-btn primary-btn" id="startPauseBtn">Start</button>
                </div>
            </div>

            <div id="completionView" class="app-view completion-screen">
                <div class="completion-icon">üéâ</div>
                <h2 class="completion-title">Journey Complete!</h2>
                <p class="completion-subtitle">You've reached your destination for today.</p>
                <div class="completion-streak" id="completionStreak"></div>
                <div class="stats-grid">
                    <div class="stat-item"><div class="stat-value" id="totalTime">0:00</div><div class="stat-label">Time</div></div>
                    <div class="stat-item"><div class="stat-value" id="exercisesCompleted">0</div><div class="stat-label">Stages</div></div>
                    <div class="stat-item"><div class="stat-value" id="caloriesBurned">~0</div><div class="stat-label">Calories</div></div>
                </div>
                <button class="control-btn primary-btn" id="restartBtn" style="width: 100%;">Start a New Journey</button>
            </div>
        </div>
    </div>

    <!-- Modals remain the same as previous version -->
    <div class="modal-overlay" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settings-title"><div class="modal-panel"><h3 class="modal-title" id="settings-title">Settings</h3><div class="setting-item"><span class="setting-label">Sound</span><div class="toggle-switch" id="soundToggleSwitch" role="switch" aria-checked="true"></div></div><div class="setting-item"><span class="setting-label">Vibration</span><div class="toggle-switch" id="vibrationToggleSwitch" role="switch" aria-checked="true"></div></div><div class="modal-actions"><button class="control-btn btn-reset" id="resetBtn">Reset Journey</button><button class="control-btn secondary-btn" id="closeSettingsBtn">Done</button></div></div></div>
    <div class="modal-overlay" id="confirmModal" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title"><div class="modal-panel"><h3 class="modal-title" id="confirm-title">Are you sure?</h3><p class="modal-text">This will end your current journey and reset all progress.</p><div class="modal-actions row"><button class="control-btn secondary-btn" id="cancelResetBtn">Cancel</button><button class="control-btn btn-confirm-reset" id="confirmResetBtn">Reset</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const EXERCISES = [
                { name: "Jumping Jacks", icon: "ü§∏" }, { name: "Wall Sit", icon: "üßò" }, { name: "Push-ups", icon: "üí™" },
                { name: "Crunches", icon: "üç´" }, { name: "Step-ups", icon: "üëü" }, { name: "Squats", icon: "üèãÔ∏è" },
                { name: "Triceps Dips", icon: "Ê§ÖÂ≠ê" }, { name: "Plank", icon: "üìè" }, { name: "High Knees", icon: "üèÉ" },
                { name: "Lunges", icon: "ü¶µ" }, { name: "Push-up & Rotate", icon: "üîÑ" }, { name: "Side Plank", icon: "üìê" }
            ];
            const PREP_TIME = 10, EXERCISE_TIME = 30, REST_TIME = 10;
            const DOMElements = {
                appContainer: document.getElementById('appContainer'), workoutView: document.getElementById('workoutView'),
                completionView: document.getElementById('completionView'), viewTitle: document.getElementById('viewTitle'),
                settingsBtn: document.getElementById('settingsBtn'), overallProgressBar: document.getElementById('overallProgressBar'),
                progressRing: document.getElementById('progressRing'), timerText: document.getElementById('timerText'),
                exerciseIcon: document.getElementById('exerciseIcon'), exerciseInfoContainer: document.getElementById('exerciseInfoContainer'),
                exerciseName: document.getElementById('exerciseName'), nextExerciseLabel: document.getElementById('nextExerciseLabel'),
                skipBtn: document.getElementById('skipBtn'), startPauseBtn: document.getElementById('startPauseBtn'),
                restartBtn: document.getElementById('restartBtn'), totalTime: document.getElementById('totalTime'),
                exercisesCompleted: document.getElementById('exercisesCompleted'), caloriesBurned: document.getElementById('caloriesBurned'),
                settingsModal: document.getElementById('settingsModal'), soundToggleSwitch: document.getElementById('soundToggleSwitch'),
                vibrationToggleSwitch: document.getElementById('vibrationToggleSwitch'), resetBtn: document.getElementById('resetBtn'),
                closeSettingsBtn: document.getElementById('closeSettingsBtn'), confirmModal: document.getElementById('confirmModal'),
                cancelResetBtn: document.getElementById('cancelResetBtn'), confirmResetBtn: document.getElementById('confirmResetBtn'),
                bgFar: document.getElementById('bg-far'), bgMid: document.getElementById('bg-mid'), bgNear: document.getElementById('bg-near'),
                streakDisplay: document.getElementById('streakDisplay'), completionStreak: document.getElementById('completionStreak'),
            };

            let state = {
                currentExerciseIndex: 0, timeLeft: PREP_TIME, status: 'initial',
                statusBeforePause: '', timerId: null, soundEnabled: true,
                vibrationEnabled: true, startTime: 0, streak: 0,
            };
            let audioCtx;

            const storage = {
                get: () => JSON.parse(localStorage.getItem('workoutJourney')) || {},
                set: (data) => localStorage.setItem('workoutJourney', JSON.stringify(data)),
            };

            const loadState = () => {
                const data = storage.get();
                state.soundEnabled = data.soundEnabled ?? true;
                state.vibrationEnabled = data.vibrationEnabled ?? true;
                
                const today = new Date().toDateString();
                const yesterday = new Date(Date.now() - 864e5).toDateString();
                
                if (data.lastCompleted === today) {
                    state.streak = data.streak || 1;
                } else if (data.lastCompleted === yesterday) {
                    state.streak = (data.streak || 0) + (data.lastCompleted === today ? 0 : 1);
                } else {
                    state.streak = 1; // Reset if more than a day has passed, but start at 1 for today
                }
                if(data.lastCompleted !== today) {
                    // Update streak for today if workout is not yet completed
                    const updatedData = { ...data, streak: state.streak };
                    // We don't save lastCompleted date until workout is done
                }
            };
            
            const saveState = (workoutCompleted = false) => {
                let data = storage.get();
                data.soundEnabled = state.soundEnabled;
                data.vibrationEnabled = state.vibrationEnabled;
                if (workoutCompleted) {
                    data.streak = state.streak;
                    data.lastCompleted = new Date().toDateString();
                }
                storage.set(data);
            };

            const initAudio = () => { if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) { state.soundEnabled = false; } } };
            const playSound = (type) => {
                if (!state.soundEnabled || !audioCtx) return;
                const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
                switch (type) {
                    case 'start': osc.frequency.setValueAtTime(440, audioCtx.currentTime); break;
                    case 'rest': osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); break;
                    case 'tick': osc.frequency.setValueAtTime(880, audioCtx.currentTime); break;
                    case 'complete': osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(1046.50, audioCtx.currentTime + 0.2); break;
                }
                osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime + 0.5);
            };
            const vibrate = (pattern) => { if (state.vibrationEnabled && navigator.vibrate) navigator.vibrate(pattern); };

            const progressRing = {
                circumference: 2 * Math.PI * 56,
                set: (percentage) => { DOMElements.progressRing.style.strokeDashoffset = progressRing.circumference - (percentage / 100) * progressRing.circumference; }
            };
            DOMElements.progressRing.style.strokeDasharray = `${progressRing.circumference} ${progressRing.circumference}`;

            const render = () => {
                const overallProgress = state.status === 'initial' ? 0 : (state.currentExerciseIndex / EXERCISES.length);
                DOMElements.overallProgressBar.style.width = `${overallProgress * 100}%`;
                DOMElements.bgFar.style.transform = `translateX(-${overallProgress * 20}%)`;
                DOMElements.bgMid.style.transform = `translateX(-${overallProgress * 35}%)`;
                DOMElements.bgNear.style.transform = `translateX(-${overallProgress * 50}%)`;

                const segmentDuration = state.status === 'exercising' ? EXERCISE_TIME : (state.status === 'resting' ? REST_TIME : PREP_TIME);
                const segmentProgress = state.status === 'initial' ? 0 : ((segmentDuration - state.timeLeft) / segmentDuration) * 100;
                progressRing.set(segmentProgress);
                DOMElements.timerText.textContent = state.timeLeft;
                DOMElements.timerText.classList.toggle('warning', state.timeLeft <= 3 && state.status !== 'initial' && state.status !== 'paused');
                
                DOMElements.exerciseInfoContainer.style.opacity = 0;
                DOMElements.exerciseIcon.classList.remove('visible');

                setTimeout(() => {
                    let currentIcon = "üöÄ", title = 'The Journey Begins', exName = 'Prepare to Start', nextLabel = `First stage: ${EXERCISES[0].name}`;
                    if (state.status === 'exercising') {
                        const currentEx = EXERCISES[state.currentExerciseIndex];
                        const nextEx = EXERCISES[state.currentExerciseIndex + 1];
                        title = `Stage ${state.currentExerciseIndex + 1}/${EXERCISES.length}`;
                        exName = currentEx.name; currentIcon = currentEx.icon;
                        nextLabel = nextEx ? `Next: ${nextEx.name}` : 'Final stage!';
                    } else if (state.status === 'resting') {
                        title = `Rest Stop`; exName = 'Breathe...';
                        nextLabel = `Next: ${EXERCISES[state.currentExerciseIndex].name}`;
                        currentIcon = "üèïÔ∏è";
                    }
                    DOMElements.viewTitle.textContent = title;
                    DOMElements.exerciseName.textContent = exName;
                    DOMElements.nextExerciseLabel.textContent = nextLabel;
                    DOMElements.exerciseIcon.textContent = currentIcon;
                    DOMElements.exerciseInfoContainer.style.opacity = 1;
                    DOMElements.exerciseIcon.classList.add('visible');
                }, 200);

                DOMElements.skipBtn.disabled = state.status === 'initial' || state.status === 'paused';
                DOMElements.startPauseBtn.textContent = (state.status === 'paused') ? 'Resume' : (state.status === 'initial' ? 'Start' : 'Pause');
                DOMElements.startPauseBtn.classList.toggle('pause', state.status === 'exercising' || state.status === 'resting');
                DOMElements.appContainer.classList.toggle('is-resting', state.status === 'resting');
                DOMElements.soundToggleSwitch.classList.toggle('active', state.soundEnabled);
                DOMElements.vibrationToggleSwitch.classList.toggle('active', state.vibrationEnabled);
                DOMElements.soundToggleSwitch.setAttribute('aria-checked', state.soundEnabled);
                DOMElements.vibrationToggleSwitch.setAttribute('aria-checked', state.vibrationEnabled);
                DOMElements.streakDisplay.textContent = state.streak > 1 ? `üî• ${state.streak}` : '';
            };

            const tick = () => {
                if (state.status === 'paused') return;
                if (state.timeLeft <= 3 && state.timeLeft > 0) playSound('tick');
                state.timeLeft--;
                if (state.timeLeft < 0) {
                    vibrate(200);
                    if (state.status === 'preparing') { state.status = 'exercising'; state.timeLeft = EXERCISE_TIME; playSound('start'); }
                    else if (state.status === 'exercising') {
                        if (state.currentExerciseIndex >= EXERCISES.length - 1) { finishWorkout(); return; }
                        state.status = 'resting'; state.timeLeft = REST_TIME; state.currentExerciseIndex++; playSound('rest');
                    } else if (state.status === 'resting') { state.status = 'exercising'; state.timeLeft = EXERCISE_TIME; playSound('start'); }
                }
                render();
            };

            const startWorkout = () => { initAudio(); vibrate(100); state.status = 'preparing'; state.startTime = Date.now(); state.timerId = setInterval(tick, 1000); tick(); };
            const pauseWorkout = () => { vibrate(50); state.statusBeforePause = state.status; state.status = 'paused'; clearInterval(state.timerId); render(); };
            const resumeWorkout = () => { vibrate(50); state.status = state.statusBeforePause; state.timerId = setInterval(tick, 1000); render(); };
            const skipSegment = () => { vibrate([50, 50, 50]); state.timeLeft = 0; tick(); };
            const finishWorkout = () => {
                clearInterval(state.timerId); state.status = 'finished'; playSound('complete'); vibrate(500);
                const elapsedSeconds = Math.round((Date.now() - state.startTime) / 1000);
                DOMElements.totalTime.textContent = `${Math.floor(elapsedSeconds / 60)}:${(elapsedSeconds % 60).toString().padStart(2, '0')}`;
                DOMElements.exercisesCompleted.textContent = EXERCISES.length; DOMElements.caloriesBurned.textContent = `~${EXERCISES.length * 5}`;
                DOMElements.completionStreak.textContent = `You're on a ${state.streak} day streak! üî•`;
                DOMElements.workoutView.style.display = 'none'; DOMElements.completionView.style.display = 'block';
                saveState(true);
            };
            const resetWorkout = () => {
                vibrate(100); clearInterval(state.timerId);
                state.currentExerciseIndex = 0; state.timeLeft = PREP_TIME; state.status = 'initial'; state.startTime = 0;
                DOMElements.workoutView.style.display = 'block'; DOMElements.completionView.style.display = 'none';
                loadState();
                render();
            };
            const toggleModal = (modal, show) => {
                const modalElement = DOMElements[modal];
                const focusableElement = modal === 'settingsModal' ? DOMElements.closeSettingsBtn : DOMElements.cancelResetBtn;
                if (show) { modalElement.classList.add('visible'); DOMElements.appContainer.setAttribute('aria-hidden', 'true'); focusableElement.focus(); }
                else { modalElement.classList.remove('visible'); DOMElements.appContainer.removeAttribute('aria-hidden'); DOMElements.settingsBtn.focus(); }
            };

            const handleKeydown = (e) => {
                if (state.status === 'initial' && e.code === 'Space') { e.preventDefault(); startWorkout(); }
                else if (state.status !== 'initial' && state.status !== 'finished') {
                    if (e.code === 'Space') { e.preventDefault(); state.status === 'paused' ? resumeWorkout() : pauseWorkout(); }
                    if (e.code === 'KeyS') { e.preventDefault(); skipSegment(); }
                }
            };
            
            document.addEventListener('keydown', handleKeydown);
            DOMElements.startPauseBtn.addEventListener('click', () => { if (state.status === 'initial') startWorkout(); else if (state.status === 'paused') resumeWorkout(); else pauseWorkout(); });
            DOMElements.skipBtn.addEventListener('click', skipSegment);
            DOMElements.restartBtn.addEventListener('click', resetWorkout);
            DOMElements.settingsBtn.addEventListener('click', () => toggleModal('settingsModal', true));
            DOMElements.closeSettingsBtn.addEventListener('click', () => toggleModal('settingsModal', false));
            DOMElements.soundToggleSwitch.addEventListener('click', () => { state.soundEnabled = !state.soundEnabled; if(state.soundEnabled) initAudio(); saveState(); render(); });
            DOMElements.vibrationToggleSwitch.addEventListener('click', () => { state.vibrationEnabled = !state.vibrationEnabled; saveState(); render(); });
            DOMElements.resetBtn.addEventListener('click', () => { toggleModal('settingsModal', false); toggleModal('confirmModal', true); });
            DOMElements.cancelResetBtn.addEventListener('click', () => { toggleModal('confirmModal', false); toggleModal('settingsModal', true); });
            DOMElements.confirmResetBtn.addEventListener('click', () => { toggleModal('confirmModal', false); resetWorkout(); });

            resetWorkout();
        });
    </script>
</body>
</html>
